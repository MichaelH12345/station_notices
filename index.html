<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Station Notices</title>

<!-- Google Fonts for reliable Open Sans loading -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    background-color: black;
    color: white;
    font-family: 'Open Sans', sans-serif;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background-color: #001f4d;
    border-bottom: 4px solid white;
    padding-left: 15px;
    flex-shrink: 0;
  }
  .header-title {
    font-family: 'Open Sans', sans-serif;
    font-weight: 700;
    font-size: 4rem;
    margin: 0;
    width: 100%;
    text-align: center;
    position: relative;
    top: 25px;
  }
  .header-row {
    display: flex;
    align-items: center;
    color: #001f4d;
    font-size: 2.5rem;
  }

  #message-container {
    flex: 1;
    background-color: black;
    padding: 0px 20px 20px 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  #message-content {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  #message-carousel {
    display: flex;
    width: 200%;
    transition: transform 0.75s ease-in-out;
    transform: translateX(-50%); /* Second slide is the visible/resting position */
    height: 100%;
  }

  .message-slide {
    width: 50%;
    flex-shrink: 0;
    position: relative;
    height: 100%;
  }

  .message-text {
    position: absolute;
    top: 25px;
    width: 100%;
    text-align: center;
    font-size: 3rem;
    max-width: 75%;
    margin-left: 12.5%;
  }

  .slide-counter {
    position: absolute;
    bottom: 92px;
    width: 100%;
    font-size: 3rem;
    color: white;
    text-align: center;
  }

  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 87.5px;
    background-color: #001f4d;
    border-top: 4px solid white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    box-sizing: border-box;
  }
  #footer-message {
    font-size: 2.5rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  #footer-time { 
    font-size: 3.5rem; 
    font-family: 'Open Sans', sans-serif;
    font-weight: 700;
  }
  #footer-time .label { 
    font-size: 60%; 
    font-family: 'Open Sans', sans-serif;
    font-weight: 400;
  }

    .fade-in {
    animation: fadeIn 0.75s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }


</style>
</head>
<body>
  <header>
    <div class="header-title" id="header-title">Station Notices</div>
    <div class="header-row">
      <div class="time">R</div>
    </div>
  </header>

  <div id="message-container">
    <div id="message-content">
      <div id="message-carousel">
        <!-- Left slide: incoming new page (comes from left) -->
        <div class="message-slide">
          <div class="message-text" id="incoming-message">Loading notices...</div>
          <div class="slide-counter" id="incoming-counter">Page 1 of 1</div>
        </div>
        <!-- Right slide: currently visible / resting position -->
        <div class="message-slide">
          <div class="message-text" id="visible-message"></div>
          <div class="slide-counter" id="visible-counter"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div id="footer-message"></div>
    <div id="footer-page"></div>
    <div id="footer-time">
      <span class="label">Time now </span>
      <span id="footer-time-value"></span>
    </div>
  </footer>

<script>
let footerMessage = document.getElementById('footer-message');
let footerTimeValue = document.getElementById('footer-time-value');
let incomingMessage = document.getElementById('incoming-message');
let visibleMessage = document.getElementById('visible-message');
let incomingCounter = document.getElementById('incoming-counter');
let visibleCounter = document.getElementById('visible-counter');
let carousel = document.getElementById('message-carousel');

let stationCode = localStorage.getItem('stationCode') || 'CAR';
let API_URL = `https://huxley2.azurewebsites.net/departures/${stationCode}/25?accessToken=e48245fd-c8d4-46b5-87ef-60e71665e6b6`;
localStorage.setItem('stationCode', stationCode);
let locationName = stationCode;
let processedMessages = [];
let currentPage = 0;
let lastPageChangeSecond = -10;
let isTransitioning = false;

function resetCarouselContainers() {
  const container = document.getElementById('message-content');
  container.innerHTML = `
    <div id="message-carousel">
      <div class="message-slide">
        <div class="message-text" id="incoming-message">Loading notices...</div>
        <div class="slide-counter" id="incoming-counter">Page 1 of 1</div>
      </div>
      <div class="message-slide">
        <div class="message-text" id="visible-message"></div>
        <div class="slide-counter" id="visible-counter"></div>
      </div>
    </div>
  `;
  incomingMessage = document.getElementById('incoming-message');
  visibleMessage = document.getElementById('visible-message');
  incomingCounter = document.getElementById('incoming-counter');
  visibleCounter = document.getElementById('visible-counter');
  carousel = document.getElementById('message-carousel');
}

function displayCurrentPage(withTransition = true) {
  try {
    if (processedMessages.length === 0) {
      incomingMessage.innerHTML = '';
      incomingCounter.textContent = '';
      visibleMessage.innerHTML = '';
      visibleCounter.textContent = '';
      carousel.style.transition = 'none';
      carousel.style.transform = 'translateX(-50%)';
      void carousel.offsetWidth;
      carousel.style.transition = 'transform 0.75s ease-in-out';
      return;
    }

    const { text, counter } = processedMessages[currentPage];

    // Single page or no transition needed → show directly in visible slide
    if (processedMessages.length <= 1 || !withTransition) {
      visibleMessage.innerHTML = text;
      visibleCounter.textContent = counter;
      incomingMessage.innerHTML = '';
      incomingCounter.textContent = '';
      carousel.style.transition = 'none';
      carousel.style.transform = 'translateX(-50%)';
      void carousel.offsetWidth;
      carousel.style.transition = 'transform 0.75s ease-in-out';
      return;
    }

    if (isTransitioning) return;
    isTransitioning = true;

    // Place new content in the incoming (left) slide
    incomingMessage.innerHTML = text;
    incomingCounter.textContent = counter;

    void carousel.offsetWidth; // Force reflow

    // Animate: move carousel right → incoming slide enters from left
    carousel.style.transform = 'translateX(0)';

    let timeout = setTimeout(() => {
      isTransitioning = false;
      console.warn('Sliding failed, resetting carousel...');
      resetCarouselContainers();
      displayCurrentPage(false);
    }, 1500);

    carousel.addEventListener('transitionend', function handler() {
      clearTimeout(timeout);
      // After animation, copy content to visible slide and reset position
      visibleMessage.innerHTML = text;
      visibleCounter.textContent = counter;
      incomingMessage.innerHTML = '';
      incomingCounter.textContent = '';
      carousel.style.transition = 'none';
      carousel.style.transform = 'translateX(-50%)';
      void carousel.offsetWidth;
      carousel.style.transition = 'transform 0.75s ease-in-out';
      isTransitioning = false;
      carousel.removeEventListener('transitionend', handler);
    }, { once: true });

  } catch (err) {
    console.error('Error during sliding animation:', err);
    resetCarouselContainers();
    setTimeout(() => displayCurrentPage(false), 1000);
  }
}

function nextPage() {
  if (processedMessages.length <= 1) return;
  currentPage = (currentPage + 1) % processedMessages.length;
  displayCurrentPage(true);
}

async function fetchNRCCMessages() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) throw new Error('API error');
    const data = await response.json();

    locationName = data.locationName || stationCode;
    const rawMessages = data.nrccMessages || [];

    let alertSummaries = [];
    try {
      const alertsResp = await fetch('https://corsproxy.io/?https://www.nationalrail.co.uk/nreapi/incidents/alerts/');
      if (alertsResp.ok) {
        const alertsData = await alertsResp.json();
        alertSummaries = alertsData
          .filter(item => Array.isArray(item.affectedTocs) && item.affectedTocs.includes('National Rail'))
          .map(item => ({
            text: `${item.summary}.<br><br>For more details,<br>visit nationalrail.co.uk.`,
            counter: ''
          }));
      }
    } catch (alertErr) {
      console.warn('Failed to fetch National Rail alerts:', alertErr);
    }

    const nrccProcessed = rawMessages.map(msg => {
      let text = msg.value || '';
      const cutIndex = text.indexOf('More details can be found in');
      if (cutIndex !== -1) text = text.substring(0, cutIndex) + '<br><br>For more details,<br>visit nationalrail.co.uk.';
      return { text, counter: '' };
    });

    processedMessages = [...alertSummaries, ...nrccProcessed];

    // Add welcome message if no other messages
    if (processedMessages.length <= 1) {
      processedMessages.unshift({
        text: `Welcome to<br>${locationName}.<br><br>For live travel information, speak to station staff, download our app or visit nationalrail.co.uk.`,
        counter: ''
      });
    }

    // Add page counters
    processedMessages = processedMessages.map((item, index) => ({
      text: item.text,
      counter: `Page ${index + 1} of ${processedMessages.length}`
    }));

    currentPage = 0;
    displayCurrentPage(false);

  } catch (err) {
    console.error('Failed to fetch NRCC messages:', err);
    processedMessages = [{
      text: `Welcome to<br>${locationName}.<br><br>For live travel information, speak to station staff, download our app or visit nationalrail.co.uk.`,
      counter: 'Page 1 of 1'
    }];
    currentPage = 0;
    displayCurrentPage(false);
  }
}

// Initial load and periodic updates
fetchNRCCMessages();
setInterval(fetchNRCCMessages, 60000);

// Full refresh every 15 minutes
setInterval(() => {
  console.log('15-minute full refresh');
  resetCarouselContainers();
  fetchNRCCMessages();
}, 15 * 60 * 1000);

function updateFooterTime() {
  const now = new Date();
  const seconds = now.getSeconds();

  footerTimeValue.textContent = now.toLocaleTimeString('en-GB', { 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit', 
    hour12: false 
  });

  // Advance page every 10 seconds
  if (seconds % 10 === 0 && seconds !== lastPageChangeSecond) {
    lastPageChangeSecond = seconds;
    nextPage();
  }
}

setInterval(updateFooterTime, 1000);
updateFooterTime();

function updateFooterDate() {
  const now = new Date();
  const weekday = now.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = now.getDate();
  const month = now.toLocaleDateString('en-GB', { month: 'long' });
  
  function getOrdinal(n) {
    if (n >= 11 && n <= 13) return n + 'th';
    switch (n % 10) {
      case 1: return n + 'st';
      case 2: return n + 'nd';
      case 3: return n + 'rd';
      default: return n + 'th';
    }
  }
  footerMessage.textContent = `${weekday} ${getOrdinal(day)} ${month}`;
}
updateFooterDate();

// Click header to change station
const headerTitle = document.getElementById('header-title');
headerTitle.style.cursor = 'pointer';
headerTitle.title = 'Click to change station code';

headerTitle.addEventListener('click', () => {
  const newStation = prompt('Enter new station code (e.g., CAR, PAD):');
  if (newStation && newStation.trim() !== '') {
    stationCode = newStation.trim().toUpperCase();
    localStorage.setItem('stationCode', stationCode);
    API_URL = `https://huxley2.azurewebsites.net/departures/${stationCode}/25?accessToken=e48245fd-c8d4-46b5-87ef-60e71665e6b6`;

    incomingMessage.innerHTML = 'Loading notices...';
    visibleMessage.innerHTML = '';
    incomingCounter.textContent = '';
    visibleCounter.textContent = '';

    fetchNRCCMessages();
  }
});

function resetToFirstMessageWithFade() {
  currentPage = 0;
  displayCurrentPage(false);

  // Add fade-in effect
  visibleMessage.classList.add('fade-in');
  visibleCounter.classList.add('fade-in');

  // Remove class after animation so it can be applied again later
  setTimeout(() => {
    visibleMessage.classList.remove('fade-in');
    visibleCounter.classList.remove('fade-in');
  }, 750);
}

// Reset messages on window resize
window.addEventListener('resize', resetToFirstMessageWithFade);

// Reset messages when tab becomes visible again
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    resetToFirstMessageWithFade();
  }
});
</script>
</body>
</html>
